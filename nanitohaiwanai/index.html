<title>何とは言わないデモ</title>
<meta charset="UTF-8">
<meta name='viewport' content='width=device-width, initial-scale=1'>
<!-- <script src="vue.min.js"></script> -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
<script src="vue.js"></script>
<style>
body {
    margin: 0;
}
svg image {
    pointer-events: none;
}
div#header {
    position: fixed;
    left: 0;
    top: 0;
    background: #0008;
    color: white;
    padding: 1rem;
    /* font-family: monospace; */
    width: 100%;
}
div#footer {
    position: fixed;
    left: 0;
    bottom: 0;
    background: #0008;
    color: white;
    padding: 1rem;
    /* font-family: monospace; */
    width: 100%;
}
div#contextmenu {
    position: fixed;
    left: 0;
    top: 0;
    background: #0008;
    color: white;
    padding: 1rem;
    font-size: large;
    font-family: monospace;
    visibility: hidden;
}
div#contextmenu a{
    color: white;
}
</style>

<div id='vue-wrap'>
    <app ref='main'>
        <div class='hoge'></div>
    </app>
</div>

<script>



// use string template to use camlecase attribute name
// see https://github.com/vuejs/vue/issues/4212
Vue.component('app', {
    template: `
        <div>
            <svg :viewBox='viewBox' :width='svg.w' :height='svg.h'
                v-on:mousemove='mouseMove'
                v-on:click='click'
                v-on:contextmenu='contextMenu'
                v-on:wheel='wheel'>
                <image x='0' y='0' :width='image.w' :height='image.h' :href='imagePath'/>
                <rect :x='Math.min(rect.sx, rect.tx)'
                      :y='Math.min(rect.sy, rect.ty)'
                      :width='Math.abs(rect.tx-rect.sx)'
                      :height='Math.abs(rect.ty-rect.sy)' stroke='red' fill='#0000'/>
                <circle
                    v-on:mousedown='mouseDown(this, 0)'
                    v-on:mouseup='mouseUp'
                    :cx='(rect.sx+rect.tx)/2'
                    :cy='(rect.sy+rect.ty)/2'
                    r='4'
                    fill='#0008'/>
                <circle
                    v-on:mousedown='mouseDown(this, 1)'
                    v-on:mouseup='mouseUp'
                    :cx='rect.sx'
                    :cy='rect.sy'
                    r='4'
                    fill='#0008'/>
                <circle
                    v-on:mousedown='mouseDown(this, 2)'
                    v-on:mouseup='mouseUp'
                    :cx='rect.tx'
                    :cy='rect.ty'
                    r='4'
                    fill='#0008'/>
            </svg>
            <div id='contextmenu' ref='contextmenu'>
                <p v-on:click="type='b'">Bird</p>
                <p v-on:click="type='n'">Non bird</p>
                <p v-on:click="type='u'">Unknown</p>
            </div>
            <div id='header'>
                User Name: {{userName}}
            </div>
            <div id='footer'>
                <div id='debug' style='display: none;'>
                    type: {{type}} <br>
                    rect: x:{{parseInt(Math.min(rect.sx, rect.tx))}}
                          y:{{parseInt(Math.min(rect.sy, rect.ty))}}
                          w:{{parseInt(Math.abs(rect.tx - rect.sx))}}
                          h:{{parseInt(Math.abs(rect.ty - rect.sy))}}<br>
                    vew: x:{{parseInt(view.x)}} y:{{parseInt(view.y)}} w:{{parseInt(view.w)}} h:{{parseInt(view.h)}}<br>
                    mouse: x:{{mouse.x}} y:{{mouse.y}} <br>
                    mousev: x:{{parseInt(mousev.x)}} y:{{parseInt(mousev.y)}} <br>
                    mouse.on: {{mouse.on}} <br>
                </div>
                <button v-on:click='init'>init</button>
            </div>
        </div>
    `,
    data: function() {
        return {
            mouse: {x: 0, y: 0, on: false, sx: 0, sy: 0, dsx: 0, dsy: 0, dtx: 0, dty: 0, type: 0},
            rect:  {sx: 0, sy: 0, tx: 0, ty: 0},
            view:  {x: 0, y: 0, w: 1000, h: 1000},
            image: {w: 1000, h: 1000},
            svg:   {w: 1000, h: 1000},
            imagePath: '',
            type: 'u',
            userName: 'unknown',
            progress: 20,
        }
    },
    computed: {
        viewBox: function() {
            return this.view.x + ' ' + this.view.y + ' ' + this.view.w + ' ' + this.view.h;
        },
        mousev: function() {
            return {
                x: this.view.x + this.mouse.x / this.svg.w * this.view.w,
                y: this.view.y + this.mouse.y / this.svg.h * this.view.h
            }
        },
    },
    watch: {
    }, 
    mounted: function() {
        // var url = new URL(window.location.href);
        // var imagePath = url.searchParams.get("imagepath");
        // var rect = url.searchParams.get("rect").split(",");

        this.svg.w = window.innerWidth;
        this.svg.h = window.innerHeight;
    },
    methods: {
        loadImage: function(imagePath) {
            var img = new Image();
            var hoge = this;
            img.onload = function() {
                hoge.imagePath = imagePath;
                hoge.image.w = this.width;
                hoge.image.h = this.height;
                hoge.init();
            }
            img.src = imagePath;
        },
        init: function() {
            var zoom = 12;
            var x = Math.min(this.rect.sx, this.rect.tx);
            var y = Math.min(this.rect.sy, this.rect.ty);
            var w = Math.abs(this.rect.tx - this.rect.sx);
            var h = Math.abs(this.rect.ty - this.rect.sy);
            this.view = {
                x: x + w/2 - this.svg.w/2/zoom,
                y: y + h/2 - this.svg.h/2/zoom,
                w: this.svg.w/zoom,
                h: this.svg.h/zoom, 
            }
        },
        mouseMove: function(event) {
            this.mouse.x = event.clientX - event.currentTarget.getBoundingClientRect().left;
            this.mouse.y = event.clientY - event.currentTarget.getBoundingClientRect().top;

            if(this.mouse.on){
                if(this.mouse.type == 0){
                    this.rect.sx = parseInt(this.mousev.x + this.mouse.dsx);
                    this.rect.sy = parseInt(this.mousev.y + this.mouse.dsy);
                    this.rect.tx = parseInt(this.mousev.x + this.mouse.dtx);
                    this.rect.ty = parseInt(this.mousev.y + this.mouse.dty);
                }
                if(this.mouse.type == 1){
                    this.rect.sx = parseInt(this.mousev.x + this.mouse.dsx);
                    this.rect.sy = parseInt(this.mousev.y + this.mouse.dsy);
                }
                if(this.mouse.type == 2){
                    this.rect.tx = parseInt(this.mousev.x + this.mouse.dtx);
                    this.rect.ty = parseInt(this.mousev.y + this.mouse.dty);
                }
            }
        }, 
        wheel: function(event) {
            var vmx = this.mousev.x;
            var vmy = this.mousev.y;
            var zoom = 1.5;
            if(event.deltaY < 0){
                zoom = 1.0/zoom;
            }
            this.view.x = vmx + (this.view.x - vmx)*zoom;
            this.view.y = vmy + (this.view.y - vmy)*zoom;
            this.view.w = this.view.w*zoom;
            this.view.h = this.view.w*this.svg.h/this.svg.w;
            this.view.w = this.view.w;
        }, 
        contextMenu: function(event) {
            event.preventDefault();
            this.$refs['contextmenu'].style.visibility = 'visible';
            this.$refs['contextmenu'].style.left = this.mouse.x;
            this.$refs['contextmenu'].style.top = this.mouse.y;
        },
        click: function(event) {
            this.$refs['contextmenu'].style.visibility = 'hidden';
        }, 
        mouseDown: function(event, type) {
            this.mouse.on = true;
            this.mouse.sx = this.mousev.x;
            this.mouse.sy = this.mousev.y;
            this.mouse.dsx = this.rect.sx - this.mousev.x;
            this.mouse.dsy = this.rect.sy - this.mousev.y;
            this.mouse.dtx = this.rect.tx - this.mousev.x;
            this.mouse.dty = this.rect.ty - this.mousev.y;
            this.mouse.type = type;
        },
        mouseUp: function(event) {
            this.mouse.on = false;
        }
    }, 
});


let app = new Vue({
    el: "#vue-wrap",
    methods: {
        setImagePath: function(imagePath) {
            this.$refs.main.loadImage(imagePath);
        },
        getRect: function(imagePath) {
            var sx = this.$refs.main.rect.sx;
            var sy = this.$refs.main.rect.sy;
            var tx = this.$refs.main.rect.tx;
            var ty = this.$refs.main.rect.ty;
            return [Math.min(sx, tx), Math.min(sy, ty), Math.abs(sx-tx), Math.abs(sy-ty)];
        },
        setRect: function(x, y, w, h) {
            this.$refs.main.rect.sx = x;
            this.$refs.main.rect.sy = y;
            this.$refs.main.rect.tx = x+w;
            this.$refs.main.rect.ty = y+h;
            this.$refs.main.init();
        },
        getType: function() {
            return this.$refs.main.type;
        },
        setUserName: function(name) {
            this.$refs.main.userName = name;
        },
        setProgress: function(progress) {
            this.$refs.main.rect.userName = progress;
        },
    },
});

// example
app.setImagePath('0fram.jpg');
app.setRect(320,300,20,20);
app.setUserName('Mizukami');
app.setProgress(20);

</script>
