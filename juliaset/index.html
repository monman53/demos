<script src='https://cdnjs.cloudflare.com/ajax/libs/three.js/104/three.min.js'></script>
<style>
body {
    margin: 0;
}
</style>

<meta charset="UTF-8">

<canvas id='canvas'></canvas>

<script type="x-shader/x-fragment" id="fs">
uniform vec2 size, range, mouse;
uniform float r;

float julia(vec2 z, vec2 c) {
    const int max_itr = 128;
    vec2 nz;
    for(int i=0;i<max_itr;i++){

        if(dot(z, z) > 4.){
            return float(i)/float(max_itr);
        }

        nz.x = z.x*z.x - z.y*z.y + c.x;
        nz.y = 2.*z.x*z.y + c.y;

        // if(z == nz) return 1.0;

        z = nz;
    }
    return 1.0;
}

void main() {
    vec2 z = (gl_FragCoord.xy - 0.5*size)*r;
    vec2 c = (mouse - 0.5*size)*r*0.7;

    // antialiasing
    float dl = r * 0.5; 
    float res = 0.;

    res += julia(z+vec2(dl*0., dl*0.), c);
    res += julia(z+vec2(dl*0., dl*1.), c);
    res += julia(z+vec2(dl*1., dl*0.), c);
    res += julia(z+vec2(dl*1., dl*1.), c);

    res *= 0.25;

    // output
    gl_FragColor = vec4(pow(res, 0.7));
}
</script>

<script>
var canvas  = document.getElementById('canvas');
canvas.width  = window.innerWidth;
canvas.height = window.innerHeight;

// prepare webgl with Three.js
var renderer = new THREE.WebGLRenderer({canvas: canvas});
var scene    = new THREE.Scene();
var camera   = new THREE.OrthographicCamera(-0.5, 0.5, 0.5, -0.5, -1, 1);
camera.position.z = 1;
scene.add(camera)

// uniforms for shader
var sx = canvas.width; 
var sy = canvas.height;
var rx = 3.5;
var ry = 2.5;
var uniforms = {
    size:   {type: 'v2',    value: new THREE.Vector2(sx, sy)},
    mouse:  {type: 'v2',    value: new THREE.Vector2(sx*0.5, sy*0.5)}, 
    range:  {type: 'v2',    value: new THREE.Vector2(rx, ry)},
    r:      {type: 'float', value: sx*ry > rx*sy ? ry/sy : rx/sx}, 
};

// prepare shaders
var screenShaderMaterial = new THREE.ShaderMaterial({
    fragmentShader: document.getElementById('fs').textContent,
    uniforms: uniforms,
});

// set plane
var plane = new THREE.PlaneGeometry(1.0, 1.0);
var mesh = new THREE.Mesh(plane, screenShaderMaterial);
scene.add(mesh);


// mouse listener
function updateMousePosition(event) {
    uniforms.mouse.value.x = event.offsetX;
    uniforms.mouse.value.y = event.offsetY;
    window.requestAnimationFrame(draw);
}
canvas.addEventListener("mousemove", updateMousePosition, false);

var draw = function() {
    renderer.render(scene, camera);
}
// start animation
draw();
</script>
